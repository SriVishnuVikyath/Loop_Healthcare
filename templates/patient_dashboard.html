{% extends 'layout.html' %}
{% block content %}
    <h1>Patient Dashboard</h1>
    <p>Welcome, <b>{{ g.profile.full_name }}</b> ({{ current_user.email }})</p>

    <hr>
    
    <!-- NEW: Your Profile Card -->
    <div class="card">
        <div class="card-header">Your Profile</div>
        <div style="padding: 15px;">
            <p><strong>Phone:</strong> {{ g.profile.phone or 'Not set' }}</p>
            <p><strong>Address:</strong> {{ g.profile.address or 'Not set' }}</p>
            <p><strong>Insurance Details:</strong>
                {% if g.profile.insurance_company %}
                    <span style="display: block; margin-left: 20px;">
                        <strong>Company:</strong> {{ g.profile.insurance_company.company_name }}<br>
                        <strong>Policy ID:</strong> {{ g.profile.insurance_policy_id }}
                    </span>
                {% else %}
                    <span style="color: #666;">No insurance on file.</span>
                {% endif %}
            </p>
            <!-- Add an Edit Profile button here later if needed -->
        </div>
    </div>
    
    <!-- NEW: Your Appointments Card (Simplified) -->
    <div class="card">
        <div class="card-header">Your Appointments</div>
        
        {% set upcoming_apts = appointments|selectattr('status', 'in', ['Pending', 'Confirmed'])|list %}
        {% set past_apts = appointments|selectattr('status', 'in', ['Cancelled', 'Completed'])|list %}

        {% if upcoming_apts %}
            <h4 style="padding: 15px 15px 0 15px;">Upcoming Appointments</h4>
            {% for apt in upcoming_apts %}
                <div class="d-flex justify-between align-center" style="padding: 10px 15px; border-bottom: 1px solid #eee;">
                    <div>
                        <b>{{ apt.doctor.full_name }}</b> ({{ apt.doctor.specialty }})<br>
                        <small>Time: {{ apt.appointment_time.strftime('%Y-%m-%d %I:%M %p') }}</small>
                    </div>
                    <div>
                        {% if apt.status == 'Pending' %}
                            <span style="font-weight: 600; color: #666;">(Pending Doctor Approval)</span>
                        {% elif apt.status == 'Confirmed' %}
                            <span style="font-weight: 600; color: green;">(Confirmed)</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
        
        {% if past_apts %}
            <h4 style="padding: 15px 15px 0 15px; margin-top: 10px;">Past/Cancelled Appointments</h4>
            {% for apt in past_apts %}
                <div class="d-flex justify-between align-center" style="padding: 10px 15px; border-bottom: 1px solid #eee;">
                    <div>
                        <b>{{ apt.doctor.full_name }}</b> ({{ apt.doctor.specialty }})<br>
                        <small>Time: {{ apt.appointment_time.strftime('%Y-%m-%d %I:%M %p') }}</small>
                    </div>
                    <div>
                        {% if apt.status == 'Cancelled' %}
                            <span style="font-weight: 600; color: #dc3545;">(Cancelled by Doctor)</span>
                        {% elif apt.status == 'Completed' %}
                             <span style="font-weight: 600; color: #007bff;">(Completed)</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        {% if not upcoming_apts and not past_apts %}
            <p style="padding: 0 15px 15px 15px;">You have no appointments.</p>
        {% endif %}
    </div>

    <!-- Doctor Search (Unchanged) -->
    <div class="card">
        <div class="card-header">Find a Doctor</div>
        <form action="{{ url_for('search_doctors') }}" method="POST">
            <div class="form-group">
                <label for="specialty">Specialty</label>
                <input type="text" id="specialty" name="specialty" placeholder="e.g., Cardiologist">
            </div>
            <!-- UPDATED: Search fields from previous step -->
            <div class="form-group">
                <label for="min_rating">Minimum Rating (1-10)</label>
                <input type="number" id="min_rating" name="min_rating" min="1" max="10" value="1" style="width: 100px;">
            </div>
            <div class="form-group">
                <label for="sort_by">Sort By</label>
                <select id="sort_by" name="sort_by">
                    <option value="default" selected>Default</option>
                    <option value="rating">Best Rating</option>
                    <option value="distance">Closest Distance</option>
                </select>
            </div>
            <button type="submit" class="btn">Search</button>
        </form>
    </div>

    <!-- NEW: Your Bills -->
    <div class="card">
        <div class="card-header">Your Bills</div>
        {% set unpaid_bills = appointments|selectattr('bill_status', 'in', ['Unpaid', 'Pending Insurance'])|list %}
        {% set paid_bills = appointments|selectattr('bill_status', 'equalto', 'Paid')|list %}
        
        {% if not unpaid_bills and not paid_bills %}
            <p>You have no bills from completed appointments.</p>
        {% endif %}

        {% if unpaid_bills %}
            <h4>Unpaid Bills</h4>
            {% for apt in unpaid_bills %}
                <div class="d-flex justify-between align-center" style="padding: 10px; border-bottom: 1px solid #eee;">
                    <div>
                        <b>${{ "%.2f"|format(apt.bill_amount) }}</b> for {{ apt.bill_description or 'consultation' }}<br>
                        <small>with {{ apt.doctor.full_name }} on {{ apt.appointment_time.strftime('%Y-%m-%d') }}</small>
                    </div>
                    <!-- UPDATED: Added View Invoice link and wrapped buttons -->
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <a href="{{ url_for('generate_invoice_pdf', appointment_id=apt.id) }}" target="_blank" class="btn-secondary" style="text-decoration: none; padding: 10px 15px; border-radius: 6px;">View Invoice</a>
                        {% if apt.bill_status == 'Unpaid' %}
                            <a href="{{ url_for('pay_bill', appointment_id=apt.id) }}" class="btn" style="text-decoration: none; padding: 10px 15px; border-radius: 6px;">Pay Bill</a>
                        {% elif apt.bill_status == 'Pending Insurance' %}
                            <!-- UPDATED: Show detailed claim status -->
                            <span style="font-weight: 600; color: #666;">
                                {% if apt.insurance_claim_status == 'Pending' %}
                                    (Pending with {{ apt.insurance_company.company_name }})
                                {% elif apt.insurance_claim_status == 'Rejected' %}
                                    <span style="color: #dc3545;">(Claim Rejected by {{ apt.insurance_company.company_name }})</span>
                                    <a href="{{ url_for('pay_bill', appointment_id=apt.id) }}" class="btn" style="text-decoration: none; padding: 10px 15px; border-radius: 6px; margin-left: 10px;">Pay Bill</a>
                                {% else %}
                                    (Processing...)
                                {% endif %}
                            </span>
                        {% elif apt.bill_status == 'Paid' %}
                            <!-- UPDATED: Show detailed paid status -->
                            <span style="font-weight: 600; color: green;">
                                (Paid
                                {% if apt.insurance_claim_status == 'Accepted' %}
                                    via {{ apt.insurance_company.company_name }}
                                {% endif %}
                                )
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
        
        {% if paid_bills %}
            <h4 style="margin-top: 20px;">Paid Bills</h4>
            {% for apt in paid_bills %}
                <div class="d-flex justify-between align-center" style="padding: 10px; border-bottom: 1px solid #eee;">
                    <div>
                        <b>${{ "%.2f"|format(apt.bill_amount) }}</b> for {{ apt.bill_description or 'consultation' }}<br>
                        <small>with {{ apt.doctor.full_name }} on {{ apt.appointment_time.strftime('%Y-%m-%d') }}</small>
                    </div>
                    <!-- UPDATED: Added View Invoice link -->
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <a href="{{ url_for('generate_invoice_pdf', appointment_id=apt.id) }}" target="_blank" class="btn-secondary" style="text-decoration: none; padding: 10px 15px; border-radius: 6px;">View Invoice</a>
                        <span style="font-weight: 600; color: green;">(Paid)</span>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- NEW: Pending Reviews -->
    <div class="card">
        <div class="card-header">Pending Reviews</div>
        <p>You have {{ doctors_to_review|length }} review(s) pending for completed appointments.</p>
        {% for doc in doctors_to_review %}
            <div class="d-flex justify-between align-center" style="padding: 10px; border-bottom: 1px solid #eee;">
                <div>
                    <b>{{ doc.full_name }}</b> ({{ doc.specialty }})
                </div>
                <a href="{{ url_for('leave_review', doctor_id=doc.id) }}" class="btn-secondary" style="text-decoration: none; padding: 10px 15px; border-radius: 6px;">Leave a Review</a>
            </div>
        {% else %}
            <p>No pending reviews. Great job!</p>
        {% endfor %}
    </div>
    
    <!-- UPDATED: Medical Record Timeline -->
    <div class="card">
        <div class="card-header">Your Medical Timeline</div>
        <ul class="timeline">
            {% for item in timeline_items %}
                {% if item.__tablename__ == 'medical_record' %}
                <!-- This is a text-based record -->
                <li class="timeline-item">
                    <div class="date">{{ item.created_at.strftime('%Y-%m-%d %I:%M %p') }}</div>
                    <h4>Visit with {{ item.doctor.full_name }} ({{ item.doctor.specialty }})</h4>
                    <p><b>Diagnosis:</b> {{ item.diagnosis }}</p>
                    <p><b>Notes:</b> {{ item.notes }}</p>
                    <p><b>Prescription:</b> {{ item.prescription }}</p>
                </li>
                {% elif item.__tablename__ == 'medical_file' %}
                <!-- This is an uploaded file -->
                <li class="timeline-item" style="background-color: #fdfdf0;">
                    <div class="date">{{ item.created_at.strftime('%Y-%m-%d %I:%M %p') }}</div>
                    <h4>File Uploaded by {{ item.doctor.full_name }}</h4>
                    <p><b>File:</b> <a href="{{ url_for('get_file', filename=item.filename) }}" target="_blank">{{ item.original_filename }}</a></p>
                    <p><b>Description:</b> {{ item.description }}</p>
                </li>
                {% endif %}
            {% else %}
                <li>No medical records or files found.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Permission Manager (Unchanged) -->
    <div class="card">
        <div class="card-header">Manage Doctor Permissions</div>
        <p>Select which doctors are allowed to view your *entire* medical history.</p>
        <form action="{{ url_for('manage_permissions') }}" method="POST">
            <div class="form-group">
                {% for doc in doctors %}
                    <div>
                        <input type="checkbox" name="doctor_ids" id="doc_{{ doc.id }}" value="{{ doc.id }}"
                            {% if doc.id in permissioned_doctors %}checked{% endif %}>
                        <label for="doc_{{ doc.id }}">{{ doc.full_name }} ({{ doc.specialty }})</label>
                    </div>
                {% else %}
                    <p>You have not had appointments with any doctors yet.</p>
                {% endfor %}
            </div>
            {% if doctors %}
                <button type="submit" class="btn-secondary">Update Permissions</button>
            {% endif %}
        </form>
    </div>
{% endblock %}