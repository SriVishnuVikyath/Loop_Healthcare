{% extends 'layout.html' %}
{% block content %}
    <h1>Patient Dashboard</h1>
    <p>Welcome, <b>{{ g.profile.full_name }}</b> ({{ current_user.email }})</p>

    <hr>
    
    <!-- Doctor Search (Unchanged) -->
    <div class="card">
        <div class="card-header">Find a Doctor</div>
        <form action="{{ url_for('search_doctors') }}" method="POST">
            <div class="form-group">
                <label for="specialty">Specialty</label>
                <input type="text" id="specialty" name="specialty" placeholder="e.g., Cardiologist">
            </div>
            <!-- UPDATED: Search fields from previous step -->
            <div class="form-group">
                <label for="min_rating">Minimum Rating (1-10)</label>
                <input type="number" id="min_rating" name="min_rating" min="1" max="10" value="1" style="width: 100px;">
            </div>
            <div class="form-group">
                <label for="sort_by">Sort By</label>
                <select id="sort_by" name="sort_by">
                    <option value="default" selected>Default</option>
                    <option value="rating">Best Rating</option>
                    <option value="distance">Closest Distance</option>
                </select>
            </div>
            <button type="submit" class="btn">Search</button>
        </form>
    </div>

    <!-- NEW: Billing Card -->
    <div class="card">
        <div class="card-header">Your Bills</div>

        <!-- Local styles for billing rows -->
        <style>
            .apt-row { padding: 10px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
            .apt-row.unpaid { background-color: #fdfdf0; }
            .apt-amount { margin: 5px 0; }
            .apt-desc { margin: 5px 0; }
        </style>

        {% set has_bills = false %}
        {% for apt in appointments %}
            {% if apt.bill_status != 'Unbilled' %}
                {% set has_bills = true %}
                <div class="apt-row {% if apt.bill_status == 'Unpaid' %}unpaid{% endif %}">
                    <div>
                        <div><b>Appointment:</b> {{ apt.appointment_time.strftime('%Y-%m-%d') }} with {{ apt.doctor.full_name }}</div>
                        <p class="apt-amount"><b>Amount:</b>
                            {% if apt.bill_amount is not none %}
                                ${{ "%.2f"|format(apt.bill_amount) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                        <p class="apt-desc"><b>Description:</b> {{ apt.bill_description or 'â€”' }}</p>
                    </div>
                    <div style="text-align:right;">
                        {% if apt.bill_status == 'Unpaid' %}
                            <p style="margin: 5px 0;"><b>Status: <span style="color: #c82333; font-weight: bold;">UNPAID</span></b></p>
                            <small style="display: block;">Please contact your doctor's office to settle.</small>
                        {% elif apt.bill_status == 'Paid' %}
                            <p style="margin: 5px 0;"><b>Status: <span style="color: green; font-weight: bold;">PAID</span></b></p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
        {% if not has_bills %}
            <p>You have no bills to display.</p>
        {% endif %}
    </div>

    <!-- NEW: Pending Reviews -->
    <div class="card">
        <div class="card-header">Pending Reviews</div>
        <p>You have {{ doctors_to_review|length }} review(s) pending for completed appointments.</p>
        {% for doc in doctors_to_review %}
            <div class="d-flex justify-between align-center" style="padding: 10px; border-bottom: 1px solid #eee;">
                <div>
                    <b>{{ doc.full_name }}</b> ({{ doc.specialty }})
                </div>
                <a href="{{ url_for('leave_review', doctor_id=doc.id) }}" class="btn-secondary" style="text-decoration: none; padding: 10px 15px; border-radius: 6px;">Leave a Review</a>
            </div>
        {% else %}
            <p>No pending reviews. Great job!</p>
        {% endfor %}
    </div>
    
    <!-- UPDATED: Medical Record Timeline -->
    <div class="card">
        <div class="card-header">Your Medical Timeline</div>
        <ul class="timeline">
            {% for item in timeline_items %}
                {% if item.__tablename__ == 'medical_record' %}
                <!-- This is a text-based record -->
                <li class="timeline-item">
                    <div class="date">{{ item.created_at.strftime('%Y-%m-%d %I:%M %p') }}</div>
                    <h4>Visit with {{ item.doctor.full_name }} ({{ item.doctor.specialty }})</h4>
                    <p><b>Diagnosis:</b> {{ item.diagnosis }}</p>
                    <p><b>Notes:</b> {{ item.notes }}</p>
                    <p><b>Prescription:</b> {{ item.prescription }}</p>
                </li>
                {% elif item.__tablename__ == 'medical_file' %}
                <!-- This is an uploaded file -->
                <li class="timeline-item" style="background-color: #fdfdf0;">
                    <div class="date">{{ item.created_at.strftime('%Y-%m-%d %I:%M %p') }}</div>
                    <h4>File Uploaded by {{ item.doctor.full_name }}</h4>
                    <p><b>File:</b> <a href="{{ url_for('get_file', filename=item.filename) }}" target="_blank">{{ item.original_filename }}</a></p>
                    <p><b>Description:</b> {{ item.description }}</p>
                </li>
                {% endif %}
            {% else %}
                <li>No medical records or files found.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Permission Manager (Unchanged) -->
    <div class="card">
        <div class="card-header">Manage Doctor Permissions</div>
        <p>Select which doctors are allowed to view your *entire* medical history.</p>
        <form action="{{ url_for('manage_permissions') }}" method="POST">
            <div class="form-group">
                {% for doc in doctors %}
                    <div>
                        <input type="checkbox" name="doctor_ids" id="doc_{{ doc.id }}" value="{{ doc.id }}"
                            {% if doc.id in permissioned_doctors %}checked{% endif %}>
                        <label for="doc_{{ doc.id }}">{{ doc.full_name }} ({{ doc.specialty }})</label>
                    </div>
                {% else %}
                    <p>You have not had appointments with any doctors yet.</p>
                {% endfor %}
            </div>
            {% if doctors %}
                <button type="submit" class="btn-secondary">Update Permissions</button>
            {% endif %}
        </form>
    </div>
{% endblock %}