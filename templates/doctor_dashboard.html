{% extends 'layout.html' %}
{% block content %}
    <h1>Doctor Dashboard</h1>
    <p>Welcome, <b>{{ g.profile.full_name }}</b> ({{ current_user.email }})</p>
    <p>Your specialty: {{ g.profile.specialty }}</p>

    <!-- NEW: Manage Availability Card -->
    <div class="card">
        <div class="card-header">Manage Your Availability</div>
        <form action="{{ url_for('manage_availability') }}" method="POST" style="padding: 15px;">
            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                <label for="start_time" style="margin-right: 10px;">Daily Start Time</label>
                <!-- Pre-fill with existing data, format as HH:MM string -->
                <input type="time" id="start_time" name="start_time" value="{{ g.profile.availability_start_time.strftime('%H:%M') if g.profile.availability_start_time else '09:00' }}" required>
            </div>
            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                <label for="end_time" style="margin-right: 10px;">Daily End Time</label>
                <input type="time" id="end_time" name="end_time" value="{{ g.profile.availability_end_time.strftime('%H:%M') if g.profile.availability_end_time else '17:00' }}" required>
            </div>
            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                <label for="slot_duration" style="margin-right: 10px;">Slot Duration (minutes)</label>
                <input type="number" id="slot_duration" name="slot_duration" value="{{ g.profile.slot_duration_minutes or 30 }}" min="10" step="5" required>
            </div>
            <button type="submit" class="btn-secondary">Update Availability</button>
        </form>
    </div>

    <div class="card">
        <div class="card-header">Pending Appointments</div>
        {% for apt in pending_apts %}
            <div class="d-flex justify-between align-center" style="padding: 10px; border-bottom: 1px solid #eee;">
                <div>
                    <b>{{ apt.patient.full_name }}</b><br>
                    {{ apt.appointment_time.strftime('%Y-%m-%d %I:%M %p') }}
                </div>
                <div>
                    <a href="{{ url_for('appointment_action', appointment_id=apt.id, action='confirm') }}" class="btn" style="margin-right: 5px;">Confirm</a>
                    <a href="{{ url_for('appointment_action', appointment_id=apt.id, action='cancel') }}" class="btn-danger" style="text-decoration: none; padding: 12px 20px; border-radius: 6px;">Cancel</a>
                </div>
            </div>
        {% else %}
            <p>No pending appointments.</p>
        {% endfor %}
    </div>

    <div class="card">
        <div class="card-header">Confirmed Appointments</div>
        {% for apt in confirmed_apts %}
             <div class="d-flex justify-between align-center" style="padding: 10px; border-bottom: 1px solid #eee;">
                <div>
                    <b>{{ apt.patient.full_name }}</b><br>
                    {{ apt.appointment_time.strftime('%Y-%m-%d %I:%M %p') }}
                </div>
                <div>
                    <a href="{{ url_for('update_record', patient_id=apt.patient.id) }}" class="btn-secondary" style="text-decoration: none; padding: 12px 20px; border-radius: 6px; margin-right: 5px;">View/Add Record</a>
                    <a href="{{ url_for('appointment_action', appointment_id=apt.id, action='complete') }}" class="btn">Mark as Completed</a>
                </div>
            </div>
        {% else %}
            <p>No confirmed appointments.</p>
        {% endfor %}
    </div>

    <div class="card">
        <div class="card-header">Completed Appointments</div>
        {% for apt in completed_apts %}
             <div class="d-flex justify-between align-center" style="padding: 10px; border-bottom: 1px solid #eee;">
                <div>
                    <b>{{ apt.patient.full_name }}</b><br>
                    {{ apt.appointment_time.strftime('%Y-%m-%d %I:%M %p') }}
                </div>
                <div style="min-width: 350px; text-align: right;">
                    <a href="{{ url_for('update_record', patient_id=apt.patient.id) }}" class="btn-secondary" style="text-decoration: none; padding: 12px 20px; border-radius: 6px; margin-right: 5px;">View History</a>
                    
                    <!-- CLEANED UP: This is the single, inline billing logic -->
                    {% if apt.bill_status == 'Unbilled' %}
                        <form action="{{ url_for('set_bill', appointment_id=apt.id) }}" method="POST" style="display: inline-flex; gap: 5px; margin-left: 5px;">
                            <input type="number" step="0.01" name="bill_amount" placeholder="$ Amount" style="width: 80px; padding: 10px;" required>
                            <input type="text" name="bill_description" placeholder="Description (e.g., 'Checkup')" style="width: 150px; padding: 10px;">
                            <button type="submit" class="btn" style="padding: 10px;">Send Bill</button>
                        </form>
                    {% elif apt.bill_status == 'Unpaid' %}
                        <span style="display: inline-block; padding: 12px; font-weight: 600;">(${{ "%.2f"|format(apt.bill_amount) }} - Unpaid)</span>
                        <a href="{{ url_for('bill_action', appointment_id=apt.id, action='pay') }}" class="btn" style="text-decoration: none; padding: 12px 20px; border-radius: 6px; margin-left: 5px;">Mark as Paid</a>
                    {% elif apt.bill_status == 'Pending Insurance' %}
                        <!-- UPDATED: Show detailed claim status -->
                        <span style="display: inline-block; padding: 12px; font-weight: 600; color: #666;">
                            (${{ "%.2f"|format(apt.bill_amount) }} - Claim {{ apt.insurance_claim_status }} with {{ apt.insurance_company.company_name }})
                        </span>
                        {% if apt.insurance_claim_status == 'Rejected' %}
                             <a href="{{ url_for('bill_action', appointment_id=apt.id, action='pay') }}" class="btn" style="text-decoration: none; padding: 12px 20px; border-radius: 6px; margin-left: 5px;">Mark as Paid</a>
                        {% endif %}
                    {% elif apt.bill_status == 'Paid' %}
                        <span style="display: inline-block; padding: 12px; font-weight: 600; color: green;">
                            (${{ "%.2f"|format(apt.bill_amount) }} - Paid
                            {% if apt.insurance_claim_status == 'Accepted' %}(via {{ apt.insurance_company.company_name }}){% endif %})
                        </span>
                    {% endif %}
                    <!-- END BILLING LOGIC -->

                </div>
            </div>
            
            <!-- REMOVED: The redundant billing management section that was here -->

        {% else %}
            <p>No completed appointments.</p>
        {% endfor %}
    </div>
{% endblock %}