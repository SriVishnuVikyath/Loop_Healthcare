{% extends 'layout.html' %}
{% block content %}
    <h1>Patient Medical History: {{ patient.full_name }}</h1>
    
    {% if has_permission %}
        <div class="alert alert-success">You have full permission to view this patient's entire history.</div>
    {% else %}
        <div class="alert alert-info">You only have permission to view records you created.</div>
    {% endif %}

    <!-- Form to "commit" a new record -->
    <div class="card">
        <div class="card-header">Add New Medical Record ("Commit")</div>
        <form method="POST">
            <div class="form-group">
                <label for="diagnosis">Diagnosis</label>
                <input type="text" id="diagnosis" name="diagnosis" required>
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="prescription">Prescription</label>
                <textarea id="prescription" name="prescription" rows="2"></textarea>
            </div>
            <button type="submit" class="btn">Save New Record</button>
        </form>
    </div>

    <!-- Patient's Timeline -->
    <div class="card">
        <div class="card-header">Patient Record Timeline</div>
        <ul class="timeline">
            {% for record in timeline %}
                <li class="timeline-item">
                    <div class="date">{{ record.created_at.strftime('%Y-%m-%d %I:%M %p') }}</div>
                    <h4>Visit with {{ record.doctor.full_name }}
                        {% if record.doctor_id == g.profile.id %}
                            (You)
                        {% endif %}
                    </h4>
                    <p><b>Diagnosis:</b> {{ record.diagnosis }}</p>
                    <p><b>Notes:</b> {{ record.notes }}</p>
                    <p><b>Prescription:</b> {{ record.prescription }}</p>
                </li>
            {% else %}
                <li>No medical records found.</li>
            {% endfor %}
        </ul>
    </div>

{% endblock %}
